---
title: "Truchet tiles collection"
output: html_notebook
---

Create a set of truchet tiles for use in tiling.

Load packages:

```{r load-packages, cache = FALSE, warning=FALSE, message=FALSE}
library(sf)
library(tidyverse)
```

Truchet curved line:
```{r}
truchet_cl <- function(){
  # Basic tile one-by-one tile:
  tile <- matrix(c(0, 0, 
                   0, 1, 
                   1, 1,  
                   1, 0,
                   0, 0),
                 ncol = 2,
                 byrow = TRUE)
  
  # Convert coordinates to polygons and then to simple features
  tile <- data.frame(geometry = st_polygon(list(tile)) %>% 
                       st_sfc()) %>% 
    st_as_sf()
  
  # Points
  pts <- data.frame(id = c("points_1", "points_2", "points_1", "points_2"), 
                    x = c(0, 0, 1, 1),
                    y = c(0, 1, 1, 0))
  
  # Convert coordinates to points and then to simple features
  pts <- pts %>%
    st_as_sf(coords = c("x", "y"))
  
  # Circle segments
  cs <- c(0.5)
  
  # Create buffers and cast to lines
  bfs <- pts %>% 
    mutate(r = cs[1], 
           geometry = pts %>%
             st_buffer(dist = r) %>% 
             pull(geometry)) %>% 
    st_cast(to = "LINESTRING") %>%
    select(-r)
  
  # Intersect lines with tile
  tile_1 <- bfs %>%
    filter(id == "points_1") %>%
    st_intersection(st_geometry(tile))
  
  tile_2 <- bfs %>%
    filter(id == "points_2") %>%
    st_intersection(st_geometry(tile))
  
  # Translate so that the tiles are centered on the point (0, 0)  
  tile_1 <- tile_1 %>%
    mutate(geometry = st_geometry(tile_1) + c(-0.5, -0.5))
  
  tile_2 <- tile_2 %>%
    mutate(geometry = st_geometry(tile_2) + c(-0.5, -0.5))
  
  tiles <- rbind(data.frame(tile_1, 
                            tile = 1),
                 data.frame(tile_2, 
                            tile = 2)) %>%
    select(-id) %>%
    st_as_sf()
  
  return(tiles)
}
```

Test:
```{r}
truchet_cl() %>% 
  ggplot() + 
  geom_sf(aes(color = factor(tile)))
```

Function for jagged lines:
```{r}
truchet_jl <- function(){
  
  # Make lines
  line_1 <- matrix(c(0, 1/10, 1/10, 3/10, 3/10, 1/2, 1/2,
                     1/2, 1/2, 7/10, 7/10, 9/10, 9/10, 1),
                   nrow = 7,
                   byrow = FALSE)
  
  line_2 <- matrix(c(1/2, 1/2, 7/10, 7/10, 9/10, 9/10, 1,
                     0, 1/10, 1/10, 3/10, 3/10, 1/2, 1/2),
                   nrow = 7,
                   byrow = FALSE)
  
  line_3 <- matrix(c(0, 1/10, 1/10, 3/10, 3/10, 1/2, 1/2,
                     1/2, 1/2, 3/10, 3/10, 1/10, 1/10, 0),
                   nrow = 7,
                   byrow = FALSE)
  
  line_4 <- matrix(c(1/2, 1/2, 7/10, 7/10, 9/10, 9/10, 1,
                     1, 9/10, 9/10, 7/10, 7/10, 1/2, 1/2),
                   nrow = 7,
                   byrow = FALSE)
  
  # Convert coordinates to lines and then to simple features
  line_1 <- data.frame(id = 1,
                       r = NA,
                       geometry = st_linestring(line_1) %>% 
                         st_sfc()) %>% 
    st_as_sf()
  
  line_2 <- data.frame(id = 2,
                       r = NA,
                       geometry = st_linestring(line_2) %>% 
                         st_sfc()) %>% 
    st_as_sf()
  
  line_3 <- data.frame(id = 3,
                       r = NA,
                       geometry = st_linestring(line_3) %>% 
                         st_sfc()) %>% 
    st_as_sf()
  
  line_4 <- data.frame(id = 4,
                       r = NA,
                       geometry = st_linestring(line_4) %>% 
                         st_sfc()) %>% 
    st_as_sf()
  
  # Make tiles:
  tile_1 <- rbind(line_1, line_2)
  
  tile_2 <- rbind(line_3, line_4)
  
  # Translate so that the origin is at the center of the tile:
  tile_1 <- tile_1 %>%
    mutate(geometry = st_geometry(tile_1) + c(-0.5, -0.5))
  
  tile_2 <- tile_2 %>%
    mutate(geometry = st_geometry(tile_2) + c(-0.5, -0.5))
  
  tiles <- rbind(data.frame(tile_1, 
                            tile = 1),
                 data.frame(tile_2, 
                            tile = 2)) %>%
    st_as_sf()
  
  return(tiles)
}
```

Test:
```{r}
truchet_jl() %>% 
  ggplot() + 
  geom_sf(aes(color = factor(tile)))
```

Function for diagonal lines:
```{r}
truchet_dl <- function(){
  
  # Make lines
  line_1 <- matrix(c(0, 1/2,
                     1/2, 1),
                   nrow = 2,
                   byrow = FALSE)
  
  line_2 <- matrix(c(1/2, 1,
                     0, 1/2),
                   nrow = 2,
                   byrow = FALSE)
  
  line_3 <- matrix(c(0, 1/2,
                     1/2, 0),
                   nrow = 2,
                   byrow = FALSE)
  
  line_4 <- matrix(c(1/2, 1,
                     1, 1/2),
                   nrow = 2,
                   byrow = FALSE)
  
  # Convert coordinates to lines and then to simple features
  line_1 <- data.frame(id = 1,
                       r = NA,
                       geometry = st_linestring(line_1) %>% 
                         st_sfc()) %>% 
    st_as_sf()
  
  line_2 <- data.frame(id = 2,
                       r = NA,
                       geometry = st_linestring(line_2) %>% 
                         st_sfc()) %>% 
    st_as_sf()
  
  line_3 <- data.frame(id = 3,
                       r = NA,
                       geometry = st_linestring(line_3) %>% 
                         st_sfc()) %>% 
    st_as_sf()
  
  line_4 <- data.frame(id = 4,
                       r = NA,
                       geometry = st_linestring(line_4) %>% 
                         st_sfc()) %>% 
    st_as_sf()
  
  # Make tiles:
  tile_1 <- rbind(line_1, line_2)
  
  tile_2 <- rbind(line_3, line_4)
  
  # Translate so that the origin is at the center of the tile:
  tile_1 <- tile_1 %>%
    mutate(geometry = st_geometry(tile_1) + c(-0.5, -0.5))
  
  tile_2 <- tile_2 %>%
    mutate(geometry = st_geometry(tile_2) + c(-0.5, -0.5))
  
  tiles <- rbind(data.frame(tile_1, 
                            tile = 1),
                 data.frame(tile_2, 
                            tile = 2)) %>%
    st_as_sf()
  
  return(tiles)
}
```

Test:
```{r}
truchet_dl() %>% 
  ggplot() + 
  geom_sf(aes(color = factor(tile)))
```

Truchet polygons 1 (see https://christophercarlson.com/portfolio/multi-scale-truchet-patterns/):
```{r}
truchet_p1 <- function(scale_p = 1){
  # scale_p = 1 scale of tiles, can be one of c(1, 1/2)
  # See https://christophercarlson.com/portfolio/multi-scale-truchet-patterns/
  
  ## CREATE BASE TILE
  #  Define square polygon
  tile <- matrix(c(0, 0, 
                   0, 1, 
                   1, 1,  
                   1, 0,
                   0, 0),
                 ncol = 2,
                 byrow = TRUE)
  
  # Convert coordinates to polygons and then to simple features
  tile <- data.frame(geometry = st_polygon(list(tile)) %>% 
                       st_sfc()) %>% 
    st_as_sf()
  
  # Points
  pts <- data.frame(id = c("points_1", "points_2", "points_1", "points_2"), 
                    x = c(0, 0, 1, 1),
                    y = c(0, 1, 1, 0))
  
  # Convert coordinates to points and then to simple features
  pts <- pts %>%
    st_as_sf(coords = c("x", "y"))
  
  # Circle segments
  cs <- c(1/3, 1/2)
  
  # Create first set of buffers and cast to polygons
  bfs_1 <- pts %>% 
    mutate(r = cs[1], 
           geometry = pts %>%
             st_buffer(dist = r) %>% 
             pull(geometry)) %>%
    select(-r)
  
  # Assemble base tile
  tile <- data.frame(color = 1,
                     st_geometry(rbind(tile,
                                       bfs_1 %>%
                                         select(-id)) %>%
                                   st_union())) %>%
    st_as_sf()
  
  ## BASE TILE DONE
  
  ## ADORNMENTS
  # Make lines for second set of buffers
  # Create buffers and cast to lines
  bfs_2 <- pts %>% 
    mutate(r = cs[2], 
           geometry = pts %>%
             st_buffer(dist = r) %>% 
             pull(geometry)) %>% 
    st_cast(to = "LINESTRING") %>%
    select(-r)
  
  # Intersect lines with tile
  line_1 <- bfs_2 %>%
    filter(id == "points_1") %>%
    st_intersection(st_geometry(tile))
  
  line_2 <- bfs_2 %>%
    filter(id == "points_2") %>%
    st_intersection(st_geometry(tile))
  
  # Buffer the lines
  bfs_2 <- rbind(line_1 %>%
                   st_buffer(dist = 1/6),
                 line_2 %>%
                   st_buffer(dist = 1/6))
  
  # Bind BASE TILE with second set of buffers
  tile_1 <- rbind(tile %>% 
                    st_difference(bfs_2 %>% 
                                    filter(id == "points_1") %>% 
                                    st_union()),
                  bfs_2 %>%
                    filter(id == "points_1") %>%
                    transmute(color = 2))
  
  tile_2 <- rbind(tile %>% 
                    st_difference(bfs_2 %>% 
                                    filter(id == "points_2") %>% 
                                    st_union()),
                  bfs_2 %>%
                    filter(id == "points_2") %>%
                    transmute(color = 2))
  ## ADORNMENTS DONE
  
  ## FINISH TILES
  # Translate so that the tiles are centered on the point (0, 0)  
  tile_1 <- tile_1 %>%
    mutate(geometry = st_geometry(tile_1) + c(-0.5, -0.5))
  
  tile_2 <- tile_2 %>%
    mutate(geometry = st_geometry(tile_2) + c(-0.5, -0.5))
  
  tiles <- rbind(data.frame(tile_1, 
                            tile = 1),
                 data.frame(tile_2, 
                            tile = 2)) %>%
    st_as_sf()
  
  ## TILES DONE
  
  ## SCALE AS REQUESTED
  if(hasArg(scale_p)){
    tiles <- tiles %>%
      mutate(geometry = st_geometry(tiles) * scale_p)
    if(scale_p == 1/2){
      # If scale is 1/2 reverse colors
      tiles <- tiles %>%
        mutate(color = case_when(color == 1 ~ 2,
                                 color == 2 ~ 1))
    }
  }
  ## FINISHED SCALING
  
  return(tiles)
}
```

Test:
```{r}
truchet_p1(scale_p = 1) %>% 
  ggplot() + 
  geom_sf(aes(fill = factor(color)),
          color = NA) +
  facet_wrap(~ tile)

truchet_p1(scale_p = 1/2) %>% 
  ggplot() + 
  geom_sf(aes(fill = factor(color)),
          color = NA) +
  facet_wrap(~ tile)
```

Function for creating mosaic given tiles:
```{r}
st_truchet <- function(t, xlim = c(1, 8), ylim = c(1, 12)){
  # t = tiles must be scale 1
  # Create grid for placing tiles
  df <- data.frame(expand.grid(x = seq(xlim[1], xlim[2], 1),
                               y = seq(ylim[1], ylim[2], 1)))
  
  # Create container for mosaic
  container <- matrix(c(min(df$x) - 0.5, min(df$y) - 0.5, 
                        min(df$x) - 0.5, max(df$y) + 0.5, 
                        max(df$x) + 0.5, max(df$y) + 0.5,  
                        max(df$x) + 0.5, min(df$y) - 0.5,
                        min(df$x) - 0.5, min(df$y) - 0.5),
                      ncol = 2,
                      byrow = TRUE)
  
  # Convert coordinates of container to polygons and then to simple features
  container <- data.frame(id = 1,
                          r = NA,
                          geometry = st_polygon(list(container)) %>% 
                            st_sfc()) %>% 
    st_as_sf()
  
  mosaic <- data.frame()
  
  for(i in 1:nrow(df)){
    mosaic <- rbind(mosaic,
                    t %>%
                      filter(tile == sample.int(2, 1)) %>%
                      mutate(group = i,
                             geometry = geometry + c(df[i, 1], df[i, 2])) %>%
                      st_as_sf())
  }
  return(list(container = container, mosaic = mosaic))
}
```

Use function to create mosaic:
```{r}
tiles <- truchet_p1()
mosaic <- st_truchet(tiles)
container <- mosaic[["container"]]
mosaic <- mosaic[["mosaic"]]


# Plot
ggplot() +
  geom_sf(data = container,
          fill = "white") +
  geom_sf(data = mosaic,
          aes(fill = factor(color)),
          color = NA) + 
  theme_void() +
  theme(legend.position = "none")
```

Function for creating multiscale tiling:
```{r}
st_truchet_ms <- function(t1, t2, prop = 0.5, xlim = c(1, 8), ylim = c(1, 12)){
  # t1 = tiles at scale 1
  # t2 = tiles at scale 1/2
  # prop = 0.5 proportion of tiles scale 1 to scale 1/2 
  # xlim = c(1, 8) limits of mosaic
  # ylim = c(1, 12) limits of mosaic
  
  # Create grid for placing tiles
  df <- data.frame(expand.grid(x = seq(xlim[1], xlim[2], 1),
                               y = seq(ylim[1], ylim[2], 1)))
  
  # Create container for mosaic
  container <- matrix(c(min(df$x) - 0.5, min(df$y) - 0.5, 
                        min(df$x) - 0.5, max(df$y) + 0.5, 
                        max(df$x) + 0.5, max(df$y) + 0.5,  
                        max(df$x) + 0.5, min(df$y) - 0.5,
                        min(df$x) - 0.5, min(df$y) - 0.5),
                      ncol = 2,
                      byrow = TRUE)
  
  # Convert coordinates of container to polygons and then to simple features
  container <- data.frame(id = 1,
                          r = NA,
                          geometry = st_polygon(list(container)) %>% 
                            st_sfc()) %>% 
    st_as_sf()
  
  mosaic <- data.frame()
  
  for(i in 1:nrow(df)){
    # Randomly select the scale of the mosaic
    if(rbinom(1, 1, p = prop) == 1){
      mosaic <- rbind(mosaic,
                      t1 %>%
                        filter(tile == sample.int(2, 1)) %>%
                        mutate(group = i,
                               geometry = geometry + c(df[i, 1], df[i, 2])) %>%
                        st_as_sf())
      
    }else{
      mosaic <- rbind(mosaic,
                      t2 %>%
                        filter(tile == sample.int(2, 1)) %>%
                        mutate(group = i,
                               geometry = geometry + c(df[i, 1] - 0.25, df[i, 2] - 0.25)) %>%
                        st_as_sf(),
                      t2 %>%
                        filter(tile == sample.int(2, 1)) %>%
                        mutate(group = i,
                               geometry = geometry + c(df[i, 1] - 0.25, df[i, 2] + 0.25)) %>%
                        st_as_sf(),
                      t2 %>%
                        filter(tile == sample.int(2, 1)) %>%
                        mutate(group = i,
                               geometry = geometry + c(df[i, 1] + 0.25, df[i, 2] - 0.25)) %>%
                        st_as_sf(),
                      t2 %>%
                        filter(tile == sample.int(2, 1)) %>%
                        mutate(group = i,
                               geometry = geometry + c(df[i, 1] + 0.25, df[i, 2] + 0.25)) %>%
                        st_as_sf())
    }
  }
  return(list(container = container, mosaic = mosaic))
}
```

Test this. First create the two scaled tiles:
```{r}
tiles_1 <- truchet_p1()
tiles_2 <- truchet_p1(scale_p = 1/2)
```

```{r}
mosaic <- st_truchet_ms(tiles_1, tiles_2, prop = 3/4)
container <- mosaic[["container"]]
mosaic <- mosaic[["mosaic"]]

# Plot
ggplot() +
  geom_sf(data = container,
          fill = "white") +
  geom_sf(data = mosaic,
          aes(fill = factor(color)),
          color = NA,
          size = 1) + 
  theme_void() +
  theme(legend.position = "none")

```

Additional multiscale tiles. Truchet polygons 2 (see https://christophercarlson.com/portfolio/multi-scale-truchet-patterns/):
```{r}
truchet_p2 <- function(scale_p = 1){
  # scale_p = 1 scale of tiles, can be one of c(1, 1/2)
  # See https://christophercarlson.com/portfolio/multi-scale-truchet-patterns/
  
  ## CREATE BASE TILE
  #  Define square polygon
  tile <- matrix(c(0, 0, 
                   0, 1, 
                   1, 1,  
                   1, 0,
                   0, 0),
                 ncol = 2,
                 byrow = TRUE)
  
  # Convert coordinates to polygons and then to simple features
  tile <- data.frame(geometry = st_polygon(list(tile)) %>% 
                       st_sfc()) %>% 
    st_as_sf()
  
  # Points
  pts <- data.frame(id = c("points_1", "points_2", "points_1", "points_2"), 
                    x = c(0, 0, 1, 1),
                    y = c(0, 1, 1, 0))
  
  # Convert coordinates to points and then to simple features
  pts <- pts %>%
    st_as_sf(coords = c("x", "y"))
  
  # Circle segments
  cs <- c(1/3)
  
  # Create first set of buffers and cast to polygons
  bfs_1 <- pts %>% 
    mutate(r = cs[1], 
           geometry = pts %>%
             st_buffer(dist = r) %>% 
             pull(geometry)) %>%
    select(-r)
  
  # Assemble base tile
  tile <- data.frame(color = 1,
                     st_geometry(rbind(tile,
                                       bfs_1 %>%
                                         select(-id)) %>%
                                   st_union())) %>%
    st_as_sf()
  
  ## BASE TILE DONE
  
  ## ADORNMENTS
  # Points
  pts <- data.frame(id = c("points_1", "points_2", "points_1", "points_2"), 
                    x = c(0, 1/2, 1, 1/2),
                    y = c(1/2, 1, 1/2, 0))
  
  # Convert coordinates to points and then to simple features
  pts <- pts %>%
    st_as_sf(coords = c("x", "y"))
  
  # Circle segments
  cs <- c(1/6)
  
  # Create first set of buffers and cast to polygons
  bfs_1 <- pts %>% 
    mutate(r = cs[1], 
           geometry = pts %>%
             st_buffer(dist = r) %>% 
             pull(geometry)) %>%
    select(-r)
  
  
  # Make lines for second set of buffers
  # Make lines
  line_1 <- matrix(c(1/2, 1/2,
                     0, 1),
                   nrow = 2,
                   byrow = FALSE)
  
  line_2 <- matrix(c(0, 1,
                     1/2, 1/2),
                   nrow = 2,
                   byrow = FALSE)
  
  # Convert coordinates to lines and then to simple features
  line_1 <- data.frame(id = "line_1",
                       r = 1/6,
                       geometry = st_linestring(line_1) %>% 
                         st_sfc()) %>% 
    st_as_sf()
  
  line_2 <- data.frame(id = "line_2",
                       r = 1/6,
                       geometry = st_linestring(line_2) %>% 
                         st_sfc()) %>% 
    st_as_sf()
  
  # Buffer the lines and join to dots
  bfs_2 <- rbind(line_1 %>%
                   st_buffer(dist = 1/6),
                 line_2 %>%
                   st_buffer(dist = 1/6)) %>%
    select(-r)
  
  # Bind BASE TILE with second set of buffers
  tile_1 <- rbind(tile %>% 
                    st_difference(bfs_1 %>% 
                                    filter(id == "points_1") %>% 
                                    st_union()) %>%
                    st_difference(bfs_2 %>% 
                                    filter(id == "line_1") %>%
                                    st_union()),
                  bfs_1 %>%
                    filter(id == "points_1") %>%
                    transmute(color = 2),
                  bfs_2 %>%
                    filter(id == "line_1") %>%
                    transmute(color = 2))
  
  tile_2 <- rbind(tile %>% 
                    st_difference(bfs_1 %>% 
                                    filter(id == "points_2") %>% 
                                    st_union()) %>%
                    st_difference(bfs_2 %>% 
                                    filter(id == "line_2") %>%
                                    st_union()),
                  bfs_1 %>%
                    filter(id == "points_2") %>%
                    transmute(color = 2),
                  bfs_2 %>%
                    filter(id == "line_2") %>%
                    transmute(color = 2))
  ## ADORNMENTS DONE
  
  ## FINISH TILES
  # Translate so that the tiles are centered on the point (0, 0)  
  tile_1 <- tile_1 %>%
    mutate(geometry = st_geometry(tile_1) + c(-0.5, -0.5))
  
  tile_2 <- tile_2 %>%
    mutate(geometry = st_geometry(tile_2) + c(-0.5, -0.5))
  
  tiles <- rbind(data.frame(tile_1, 
                            tile = 1),
                 data.frame(tile_2, 
                            tile = 2)) %>%
    st_as_sf()
  
  ## TILES DONE
  
  ## SCALE AS REQUESTED
  if(hasArg(scale_p)){
    tiles <- tiles %>%
      mutate(geometry = st_geometry(tiles) * scale_p)
    if(scale_p == 1/2){
      # If scale is 1/2 reverse colors
      tiles <- tiles %>%
        mutate(color = case_when(color == 1 ~ 2,
                                 color == 2 ~ 1))
    }
  }
  ## FINISHED SCALING
  
  return(tiles)
}
```

Test:
```{r}
truchet_p2(scale_p = 1) %>% 
  ggplot() + 
  geom_sf(aes(fill = factor(color)),
          color = NA) +
  facet_wrap(~ tile)

truchet_p2(scale_p = 1/2) %>% 
  ggplot() + 
  geom_sf(aes(fill = factor(color)),
          color = NA) +
  facet_wrap(~ tile)
```

Test these tiles. First create the two scaled tiles:
```{r}
tiles_1 <- truchet_p2()
tiles_2 <- truchet_p2(scale_p = 1/2)
```

Create mosaic:
```{r}
mosaic <- st_truchet_ms(tiles_1, tiles_2, prop = 1/4)
container <- mosaic[["container"]]
mosaic <- mosaic[["mosaic"]]

# Plot
ggplot() +
  geom_sf(data = container,
          fill = "white") +
  geom_sf(data = mosaic,
          aes(fill = factor(color)),
          color = NA,
          size = 1) + 
  theme_void() +
  scale_fill_manual(values = c("2" = "black", "1" = "white")) +
  theme(legend.position = "none")

ggsave(filename = "truchet-p2-black-on-white.png", 
        width = 8, 
        height = 12, 
        units = "in")
```

Create mosaic:
```{r}
mosaic <- st_truchet_ms(tiles_1, tiles_2, prop = 1/4)
container <- mosaic[["container"]]
mosaic <- mosaic[["mosaic"]]

# Plot
ggplot() +
  geom_sf(data = container,
          fill = "white") +
  geom_sf(data = mosaic,
          aes(fill = factor(color)),
          color = NA,
          size = 1) + 
  theme_void() +
  scale_fill_manual(values = c("1" = "black", "2" = "white")) +
  theme(legend.position = "none")

ggsave(filename = "truchet-p2-white-on-black.png", 
        width = 8, 
        height = 12, 
        units = "in")
```

Combine tiles of type 1 and type 2:
```{r}
tiles_1 <- rbind(truchet_p1() %>%
                   filter(tile == 1),
                 truchet_p2() %>%
                   filter(tile == 2))
tiles_2 <- rbind(truchet_p1(scale_p = 1/2) %>%
                   filter(tile == 2),
                 truchet_p2(scale_p = 1/2) %>%
                   filter(tile == 1))
```

Create mosaic:
```{r}
mosaic <- st_truchet_ms(tiles_1, tiles_2, prop = 1/2)
container <- mosaic[["container"]]
mosaic <- mosaic[["mosaic"]]

# Plot
ggplot() +
  geom_sf(data = container,
          fill = "white") +
  geom_sf(data = mosaic,
          aes(fill = factor(color)),
          color = NA,
          size = 1) + 
  theme_void() +
  scale_fill_manual(values = c("1" = MexBrewer::mex.brewer("Revolucion")[5], "2" = MexBrewer::mex.brewer("Revolucion")[7])) +
  theme(legend.position = "none")

ggsave(filename = "truchet-p1-p2-revolucion.png", 
        width = 8, 
        height = 12, 
        units = "in")
```

Additional multiscale tiles. Truchet polygons 2 (see https://christophercarlson.com/portfolio/multi-scale-truchet-patterns/):
```{r}
truchet_p3 <- function(scale_p = 1){
  # scale_p = 1 scale of tiles, can be one of c(1, 1/2)
  # See https://christophercarlson.com/portfolio/multi-scale-truchet-patterns/
  
  ## CREATE BASE TILE
  #  Define square polygon
  tile <- matrix(c(0, 0, 
                   0, 1, 
                   1, 1,  
                   1, 0,
                   0, 0),
                 ncol = 2,
                 byrow = TRUE)
  
  # Convert coordinates to polygons and then to simple features
  tile <- data.frame(geometry = st_polygon(list(tile)) %>% 
                       st_sfc()) %>% 
    st_as_sf()
  
  # Points
  pts <- data.frame(id = c("points_1", "points_2", "points_1", "points_2"), 
                    x = c(0, 0, 1, 1),
                    y = c(0, 1, 1, 0))
  
  # Convert coordinates to points and then to simple features
  pts <- pts %>%
    st_as_sf(coords = c("x", "y"))
  
  # Circle segments
  cs <- c(1/3)
  
  # Create first set of buffers and cast to polygons
  bfs_1 <- pts %>% 
    mutate(r = cs[1], 
           geometry = pts %>%
             st_buffer(dist = r) %>% 
             pull(geometry)) %>%
    select(-r)
  
  # Assemble base tile
  tile <- data.frame(color = 1,
                     st_geometry(rbind(tile,
                                       bfs_1 %>%
                                         select(-id)) %>%
                                   st_union())) %>%
    st_as_sf()
  
  ## BASE TILE DONE
  
  ## ADORNMENTS
  # Points
  pts <- data.frame(id = c("points_1", "points_2"), 
                    x = c(1, 0),
                    y = c(1, 0))
  
  # Convert coordinates to points and then to simple features
  pts <- pts %>%
    st_as_sf(coords = c("x", "y"))
  
  # Circle segments
  cs <- c(1/2)
  
  # Create buffers and cast to lines
  bfs_2 <- pts %>% 
    mutate(r = cs[1], 
           geometry = pts %>%
             st_buffer(dist = r) %>% 
             pull(geometry)) %>% 
    st_cast(to = "LINESTRING") %>%
    select(-r)
  
  # Intersect lines with tile
  line_1 <- bfs_2 %>%
    filter(id == "points_1") %>%
    st_intersection(st_geometry(tile))
  
  line_2 <- bfs_2 %>%
    filter(id == "points_2") %>%
    st_intersection(st_geometry(tile))
  
  # Buffer the lines
  bfs_2 <- rbind(line_1 %>%
                   st_buffer(dist = 1/6),
                 line_2 %>%
                   st_buffer(dist = 1/6))
  
  
  # Bind BASE TILE with second set of buffers
  tile_1 <- rbind(tile %>% 
                    st_difference(bfs_1 %>% 
                                    filter(id == "points_1") %>% 
                                    st_union()) %>%
                    st_difference(bfs_2 %>% 
                                    filter(id == "points_1") %>%
                                    st_union()),
                  bfs_1 %>%
                    filter(id == "points_1") %>%
                    transmute(color = 2),
                  bfs_2 %>%
                    filter(id == "points_1") %>%
                    transmute(color = 2))
  
  tile_2 <- rbind(tile %>% 
                    st_difference(bfs_1 %>% 
                                    filter(id == "points_2") %>% 
                                    st_union()) %>%
                    st_difference(bfs_2 %>% 
                                    filter(id == "points_2") %>%
                                    st_union()),
                  bfs_1 %>%
                    filter(id == "points_2") %>%
                    transmute(color = 2),
                  bfs_2 %>%
                    filter(id == "points_2") %>%
                    transmute(color = 2))
  ## ADORNMENTS DONE
  
  ## FINISH TILES
  # Translate so that the tiles are centered on the point (0, 0)  
  tile_1 <- tile_1 %>%
    mutate(geometry = st_geometry(tile_1) + c(-0.5, -0.5))
  
  tile_2 <- tile_2 %>%
    mutate(geometry = st_geometry(tile_2) + c(-0.5, -0.5))
  
  tiles <- rbind(data.frame(tile_1, 
                            tile = 1),
                 data.frame(tile_2, 
                            tile = 2)) %>%
    st_as_sf()
  
  ## TILES DONE
  
  ## SCALE AS REQUESTED
  if(hasArg(scale_p)){
    tiles <- tiles %>%
      mutate(geometry = st_geometry(tiles) * scale_p)
    if(scale_p == 1/2){
      # If scale is 1/2 reverse colors
      tiles <- tiles %>%
        mutate(color = case_when(color == 1 ~ 2,
                                 color == 2 ~ 1))
    }
  }
  ## FINISHED SCALING
  
  return(tiles)
}
```

Test tiles of type 3:
```{r}
tiles_1 <- truchet_p3()
tiles_2 <- truchet_p3(scale_p = 1/2)
```

Create mosaic:
```{r}
mosaic <- st_truchet_ms(tiles_1, tiles_2, prop = 0)
container <- mosaic[["container"]]
mosaic <- mosaic[["mosaic"]]

# Plot
ggplot() +
  geom_sf(data = container,
          fill = "white") +
  geom_sf(data = mosaic,
          aes(fill = factor(color)),
          color = NA,
          size = 1) + 
  theme_void() +
  scale_fill_manual(values = c("1" = "white", "2" = MexBrewer::mex.brewer("Alacena")[9])) +
  theme(legend.position = "none")
```

```{r}
mosaic_2 <- mosaic %>%
  group_by(color) %>%
  summarize(color = max(color))
```

```{r}
mosaic_3 <- mosaic_2[1,] %>%
  st_difference(mosaic_2[2,]) %>%
  st_cast(to = "POLYGON") %>%
  mutate(area = st_area(geometry))
```

```{r}
ggplot() +
  geom_sf(data = container,
          color = NA,
          fill = "white") +
  geom_sf(data = mosaic_3 %>%
            filter(area > 0.28 & area < 0.2944235),
          fill = "red") +
  geom_sf(data = mosaic_2[2,] %>%
            st_crop(container),
          color = NA,
          fill = "blue") +
  theme_void()


ggsave(filename = "truchet-p3-white-on-blue.png", 
        width = 8, 
        height = 12, 
        units = "in")
```
